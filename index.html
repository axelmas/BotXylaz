$(document).ready(function () {
  const chatHistory = $('#chat-history');
  const promptInput = $('#prompt');
  const submitButton = $('#submit-btn');

  // Add messages to chat history
  function addMessage(message, sender) {
    const messageClass = sender === 'user' ? 'user-message' : 'ai-message';
    const messageElement = `<p class="${messageClass}">${sender}: ${message}</p>`;
    chatHistory.append(messageElement);
    chatHistory.scrollTop(chatHistory[0].scrollHeight); // Auto-scroll to the bottom
  }

  // OpenAI API Response Function
  async function getAIResponse(prompt) {
    try {
      const response = await fetch('http://localhost:3000/api/chat', { // Llamada a tu servidor backend
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ prompt: prompt }), // Pasamos el mensaje al backend
      });

      if (!response.ok) {
        console.error('API error:', response.statusText);
        return 'Xylaz encountered an issue.';
      }

      const data = await response.json();
      return data.response; // Respuesta del bot desde el backend
    } catch (error) {
      console.error('Fetch error:', error);
      return 'Connection to Xylaz failed.';
    }
  }

  // Handle user input
  submitButton.click(async function () {
    const userMessage = promptInput.val();
    if (!userMessage) return;

    addMessage(userMessage, 'user');
    promptInput.val(''); // Clear input field

    addMessage('Xylaz is thinking...', 'bot');
    const botResponse = await getAIResponse(userMessage);

    // Replace the "thinking" message with the bot's response
    chatHistory.find('p.ai-message').last().text(`Xylaz: ${botResponse}`);
  });

  // Send message on Enter key press
  promptInput.keypress(function (event) {
    if (event.which === 13) {
      event.preventDefault();
      submitButton.click();
    }
  });
});
